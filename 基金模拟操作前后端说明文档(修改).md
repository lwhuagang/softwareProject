### `基金模拟操作前后端说明文档

> 这个文件主要描述了模拟操作中后端需要注意维护的每个指标的内容含义以及公式定义，以及大致描述了我对后端模拟操作中整体业务逻辑的认知还有前后端交互的一些内容。由于基金模拟买入卖出是核心功能，十分复杂，以及要保证计算的正确性和严谨性，为了减轻后端同志的工作量写了这个文件。有什么问题欢迎大家随时在群里一起讨论。

#### 针对每个用户总体

> 以下为针对每个用户来说后端需要维护的所有模拟操作数据

- 初始总资产：x元，此为定值，为用户初始自己设定的值，**不能改变！！！**,除非重置，所以在用户注册的时候提示建议用户设大一点的值，用户想用多少自己就用多少。（不能改变的目的是为了尽量模拟真实环境，因为没有一个现实中的人拥有无限资产）
- 总持有金额：$\sum$所有持有基金的持有金额。
- 可用资金：可用资金为用户目前还有多少钱能够买基金。
- 总资产：总持有金额 + 可用资金
- 总日收益：$\sum$用户持有的每一个基金日收益
- 总持有成本:   $\sum$用户持有的每一个基金的持有成本
- 总持有收益：总持有金额   -  总持有成本
- 总累计收益： 用户所获得的总资产上的累计收益
  - 算法1：总资产 - 初始总资产(选择该算法)
  - 算法2：用户买过的所有基金的累计收益之和
- 总持有收益率：总持有收益 / 总持有成本。**注意这个指标很有意义，因为拿这个指标去跟其他人比较才有意义，这个指标反映了一个人的投资水平**。后期可以去做一个用户排行榜出来，依据的指标就是这个。
- 资产收益率：总累计收益 / 初始总资产。这个指标反应了一个人资产运作能力。注意跟上面的指标进行区分



####  针对用户持有的每个基金

> 下面为针对用户持有的单个基金的后端需要维护的所有模拟操作数据，注意与上面区分

- 基金名称
- 基金单位净值： 熊博士接口每天3点以后，大概晚上8，9点钟会对当日基金单位净值进行更新
- 日收益： 当前基金持有金额 $\times$ 基金日涨幅
- 持有金额：目前用户所持有的基金市值。基金的市值是指持有基金的份额$\times$基金单位净值
  - 算法1：持有份额 $\times$单位净值(选择该算法)
  - 算法2：持有成本  +  $\sum$之前每一天的日收益金额
- 持有成本：用户每次进行买入操作，扣除买入费率以后的净买入金额的累加
- 持有收益：初始化为0
  - 算法1：持有金额 - 持有成本(选择该算法)
  - 算法2：（基金目前单位净值 - 持仓成本价）*  持有份额
- 持有收益率：持有收益 / 持有成本
- 持有份额：持有份额是衡量用户持有某一基金份额数量的指标。初始为0。
- 持仓成本价：持有成本  /  持有份额
- 累计收益：用户在某一个基金上累计获得的收益。**注意这个指标需要存成一个30元素数组，统计了之前30天的基金累计收益数据，前端需要画图（参照支付宝）(redis存储)**。这里注意理解累计收益与持有收益的区别。
  - 算法1：持有收益 + 用户此前在此基金上进行的所有卖出的净卖出收益之和
  - 算法2:  前一天的累计收益加上当日收益(使用该算法)

#### 每日更新操作

> 以下为后端执行每日更新的操作内容。每个股市交易日结束以后都要做更新数据操作，没有列出的应该不用变化。

##### 基金

- 基金日收益：按照公式  **当前基金持有金额 $\times$ 基金日涨幅**进行更新

- 某一基金持有金额： 原来的持有金额 + 基金日收益

- 某一基金持有收益：原来的持有收益 + 基金日收益
- 某一基金累计收益：原来的累计收益 + 基金日收益
- 某一基金持有收益率： 持有收益   / （ 持有金额 - 持有收益 ）= 持有收益  /  持有成本
- 某一基金持有成本 ： 不变。

##### 用户

- 用户总日收益：$\sum$用户持有的每一个基金日收益

- 用户总持有收益: 原来的用户总持有收益 + 用户总日收益
- 用户总持有收益率： 用户总持有收益 / 总持有成本
- 用户总持有金额（总金额）：用户原来的总持有金额 + 用户总日收益。

- 用户总资产：用户原来的总资产 + 用户总日收益
- 用户总累计收益：用户原来的总累计收益 + 用户总日收益
- 资产收益率： 用户总累计收益 / 用户的初始总资产

#### 买入操作（针对某基金)

> 下面为后端执行买入操作的内容。注意买入与卖出是在已经做完每日必备更新操作以后再依次进行的

前端提供：用户email，基金代码，买入金额

##### 定义

- 买入金额（前端提供）：用户买入时用买入金额进行操作（因为不知道基金净值是多少)
- 买入手续费： 买入金额 $ \times$ 当前买入费率
- 净买入金额： 买入金额 - 买入手续费
- 买入份额： 净买入金额 / **更新以后的净值**（注意分3点前买入和3点后买入）。买入份额直接添加到用户对某一基金的持有份额中。 
- 成交时间：当天净值更新以后成交（可参考下面*建议*中的第二条)

##### 更新：

###### 基金

- 基金的持有份额：原来的基金持有份额 + 买入份额
- 基金持有成本 ： 原来的基金持有成本 + 净买入金额
- 基金持有金额：原来的基金持有金额 + 净买入金额
- 基金持有收益：注意买入操作成交以后**持有收益并不会变**
- 基金持有收益率：基金持有收益 / 基金持有成本
- 基金持仓成本价：按照公式进行更新即可，注意买入会改变持仓成本价、
- 基金累计收益： 原来的基金累计收益 - 买入手续费

###### 用户

- 用户总持有收益：**不变**
- 总持有金额： 原来的总持有金额 + 净买入金额
- 总持有成本:   用户原来的总持有成本 + 净买入金额
- 总持有收益率： 用户总持有收益 / 用户总持有成本  
- 用户可用资金：原来的用户可用资金 - 用户买入金额
- 用户总资产： 用户原来的总资产 - 买入手续费
- 用户总累计收益： 用户原来的总累计收益 - 买入手续费
- 资产收益率： 用户总累计收益 / 用户的初始总资产



#### 卖出操作（针对某基金)

> 下面为后端执行卖出操作的内容。

前端提供：用户Email，基金代码，卖出份额（注意当然不一定全卖）

##### 定义

- 卖出份额（前端提供) ： 卖出按照份额进行卖出
- 卖出金额： 卖出份额 $\times$ 基金更新以后净值(注意时间三点前或三点后)
- 卖出成本：  卖出份额 $\times$ 持仓成本价
- 卖出手续费： 按照交易规则进行计算（详见下面注意第二条)
- 净卖出金额： 卖出金额 - 卖出手续费
- 卖出收益： 卖出金额 - 卖出成本
- 净卖出收益：卖出收益 - 卖出手续费

##### 更新：

###### 基金

- 基金的持有份额： 原来的持有份额 - 卖出份额
- 基金持有成本： 
  - 算法1：原来的持有成本  -   卖出成本(选择该算法)
  - 算法2：原来的持有成本$\times$ (新的持有份额  /  原来的持有份额)
- 基金持有金额： 原来的持有金额 - 卖出金额
- 基金持有收益：原来的持有收益 - 卖出收益
- 基金累计收益：基金原来的累计收益 - 基金卖出手续费
- 基金持仓成本价:  **注意卖出操作并不改变基金持仓成本价**
- 基金持有收益率：**注意卖出操作并不改变基金持有收益率**（因为持仓成本价不变）

###### 用户

- 用户的总持有收益：原来的总持有收益 - 卖出收益
- 用户的总持有金额： 原来的总持有金额 - 净卖出金额
- 用户的总持有成本： 用户原来的总持有成本 - 卖出成本
- 总持有收益率：总持有收益 / 总持有成本。（注意这个可能会变）
- 用户可用资金：原来的用户可用资金 + 净卖出金额
- 用户总累计收益： 用户原来的总累计收益 - 基金卖出手续费
- 资产收益率： 用户总累计收益  /  用户的初始总资产
- 用户总资产： 用户原来的总资产 - 卖出手续费

#### 交易记录

- 每次用户进行交易的时候，交易会以记录的形式先存到前端的交易记录界面里面，然后以request形式把记录发送到后端，存到后端每个用户的交易记录队列里面。

#### 注意

- 所有的更新操作中没有列出的指标应该是不用改变的（不排除我有忘记的指标可能性，所以大家尽量都能看一下文档）
- 注意基金净值的选取：是3点前申请就是当天的净值，是3点后申请就是下一天的净值
- 注意买入费率熊博士接口里面有，但是卖出费率接口里没有。故需要统一(**改天大家一起讨论下这个问题**)
- 注意上面的所有用户属性之间要满足自洽，即可以互相推出，不能产生矛盾。

#### 建议

- 注意要维护好上面的每一项数据，因为前端都有可能去调用（同时也为了体现我们软件的专业性、真实性、严谨性）我们会尽可能display多的数据，这可以作为我们软件的一个优点。具体如何计算不做要求，因为有多种算法都能达到目的，只要保证算对就行，保证每个指标的含义不变就行。

- 建议白天用户每次进行买入卖出操作的时候，前端调用接口把参数传到后端，后端先把操作存到队列里面。到晚上12点时候统一进行操作（因为那个时候基金的净值肯定都已经更新了）。可以把更新每日信息，买入，卖出写成3个函数，按顺序依次执行即可。

  - > 或者还有一种方法是等基金净值进行更新的时候操作，但就需要后端不断请求netWorthDate看是否更新。这个大家可以讨论下

- **后端可根据此文档，进行相应数据库表项的设计，以及类的属性和方法的设计。**

#### 接口要求

尽量把相似接口功能能归类的归类（把返回数据放到一个json对象里），减少接口数量。然后提供的接口文档里面每个接口要写清楚各项参数含义和格式等，按照如下范例格式：

**接口地址**：localhost:8080/user/havingList

**接口功能**：获取用户目前持有的所有基金信息

**请求方式**：get/post

**请求参数说明：**

-  code   -  基金代码

-  email    -  用户email

**返回格式**：JSON

可能的几个前后端交互接口：用户请求买入接口，请求卖出接口，查询交易记录接口，查询用户总体模拟信息接口（要返回最上面列出的用户总体的所有数据），查询用户持有某一基金信息的接口（要返回最上面针对用户持有某一基金中的所有数据）



